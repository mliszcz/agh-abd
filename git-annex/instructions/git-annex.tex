\documentclass[polish]{article}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[polish]{babel}
\usepackage{a4wide}
\usepackage{color}
\usepackage{latexsym}
\usepackage{listings}
\usepackage{hyperref}

\title{\textbf{Instrukcja do ćwiczenia}\\git-annex}
\author{Michał Liszcz \and Jakub Sawicki}
\newif\ifteacher
\teacherfalse
\begin{document}
\maketitle

\begin{tabular}{|l|p{.7\textwidth}|}
\hline
Data wykonania & \\
\hline
Skład Grupy & \\
\hline
Ocena & \\
\hline
\end{tabular}

\vspace{0.5cm}
\noindent \textbf{Podczas wykonywania ćwiczenia odznaczaj wykonane podpunkty!}

\noindent Przed przystąpieniem do ćwiczenia sprawdź obecność i stan sprzętu.
Wszelkie nieprawidłowości należy natychmiast zgłosić prowadzącemu.
\vspace{0.5cm}

\renewcommand{\labelenumi}{$\Box$~\texttt{\theenumi}}
\renewcommand{\labelenumii}{$\Box$~\texttt{\theenumii}}

%\subsection*{Zestawienie sprzętu}

%W skład stanowiska wchodzą dwa komputery oraz biblioteka dysków
%magneto-optycznych HP 660ex. Biblioteka podpięta jest do komputera o
%nazwie droid2.


\begin{enumerate}

    \item
    Skonfiguruj dwie maszyny wirtualne \texttt{centos6} z zainstalowanymi
    następującymi paczkami (git-annex dostępny jest w repozytorium EPEL
    \footnote{CentOS6.2 dostępny w laboratorium nie posiada go w repozytorium.
        Konieczne jest ściągnięcie i zainstalowanie paczki
        \texttt{epel-release-6-8.noarch}. Pomocne może być także uaktualnienie
        certyfikatów: \texttt{yum upgrade ca-certificates}.},
    pozostałe są w standardowych repozytoriach):

    \begin{itemize}
      \item git >= 1.7.1
      %\item rsync >= 3.0.6
      %\item openssh-server >= 5.3p1
      \item git-annex >= 3.20120522
    \end{itemize}

    Dodaj w pliku \texttt{/etc/hosts} wpisy, by maszyny były dostępne pod
    nazwami \texttt{hostA} i \texttt{hostB}.

\ifteacher
    \begin{lstlisting}
yum upgrade ca-certificates

wget http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
rpm -ivh epel-release-6-8.noarch.rpm
    \end{lstlisting}
\fi

    \item
    Na obu maszynach skonfiguruj serwer SSH, utwórz użytkownika \texttt{git}
    oraz utwórz dla niego parę kluczy (\texttt{ssh-keygen}) Wymień klucze
    publiczne między maszynami (\texttt{ssh-copy-id}) tak, by było możliwe
    logowanie przy ich pomocy.

    Sprawdź czy z każdej maszyny możesz zalogować się na drugą z nich:

    \begin{lstlisting}
git@hostA:~$ ssh git@hostB
git@hostB:~$ ssh git@hostA
    \end{lstlisting}

    \item
    Utwórz na obu maszynach repozytoria \texttt{hostA-main} i
    \texttt{hostB-main} (gdzie prefiks oznacza maszynę, na której dane
    repozytorium powinno się znajdować). w każdym z repozytoriów zainicjalizuj
    git-annex i dodaj drugie repozytorium jako remote.

    \begin{lstlisting}
git@hostA:~$ git init hostA-main.git
git@hostA:~$ cd hostA-main.git
git@hostA:hostA-main.git$ git annex init 'hostA - main'

...

git@hostA:hostA-main.git$ git remote add hostB-main git@hostB:hostB-main.git
    \end{lstlisting}

    \item
    W repozytorium \texttt{hostA-main} utwórz plik \texttt{important\_file.txt}
    i dodaj go do indeksu git-annex. Uzyskaj dostęp do zawartości pliku na
    maszynie \texttt{hostB}. Zweryfikuj gdzie znajduje się aktualnie plik z
    \texttt{hostA} i \texttt{hostB}.

    \item
    Zmodyfikuj zawartość pliku w \texttt{hostB-main} i zweryfikuj jak
    rozprzestrzeniają się zmiany.

    \item
    Utwórz kolejne repozytorium \texttt{hostB-backup}.
    Powinno to być repozytorium, które przechowywane będzie na dysku backupowym
    \texttt{/dev/sdb} (utwórz odpowiednią partycję i zamontuj w
    \texttt{/mnt/backup}).

\ifteacher
    \begin{lstlisting}
hostB$ fdisk /dev/sdb -> utworzenie nowej partycji
hostB$ mkfs.ext4 /dev/sdb1
hostB$ mkdir /mnt/backup
hostB$ mount /dev/sdb1 /mnt/backup
    \end{lstlisting}
\fi

    \item
    Utwórz plik \texttt{plik.bin} o wielkości 500MB w \texttt{hostB-main}.
    Zbadaj szybkość
    transferu przy kopiowaniu pliku do \texttt{hostA-main} (przez SSH) i do
    \texttt{hostB-media} (kopia lokalna).

    \begin{tabular}{|l|p{.7\textwidth}|}
    \hline
    & prędkość transferu [MB/s] \\
    \hline
    przez SSH & \\
    \hline
    kopia lokalna & \\
    \hline
    \end{tabular}

\ifteacher
    Przykładowe wyniki:

    \begin{lstlisting}
[root@lab429-08 hostB-main.git]# git annex copy --to hostA-main plik.bin
copy plik.bin (checking hostA-main...) (to hostA-main...) SHA256-s512000000--4c98cf638799a07eb85872e7f5f5d8d661c09e6e15af02f3655ed9250cae13b0
512000000 100\% 45.98MB/s 0:00:10 (xfer#1, to-check=0/1)

sent 512062644 bytes received 31 bytes 48767873.81 bytes/sec
total size is 512000000 speedup is 1.00
ok
(Recording state in git...)


[root@lab429-08 hostB-main.git]# git annex copy --to hostB-backup plik.bin
copy plik.bin (to hostB-backup...) SHA256-s512000000--4c98cf638799a07eb85872e7f5f5d8d661c09e6e15af02f3655ed9250cae13b0
512000000 100\% 115.10MB/s 0:00:04 (xfer#1, to-check=0/1)

sent 512062644 bytes received 31 bytes 113791705.56 bytes/sec
total size is 512000000 speedup is 1.00
ok
(Recording state in git...)
    \end{lstlisting}
\fi

    \item
    Zbadaj działanie flagi numcopies. Zwróć uwagę na to, że wersja git-annex
    dostępna w repozytorium centos6 nie implementuje jeszcze polecenia
    \texttt{numcopies}.

    \begin{itemize}
        \item Ustaw flagę \texttt{numcopies} na 2.
        \item Następnie utwórz w wybranym repozytorium bardzo ważny plik
              (\texttt{my\_data.txt}) i skopiuj go do jednego z pozostałych
              repozytoriów, tak by w systemie były dwie kopie.
        \item Spróbuj porzucić plik lokalnie i obserwuj wyniki.
    \end{itemize}

    \item
    Umieść plik z poprzedniego punktu w dwóch zdalnych repozytoriach i porzuć
    lokalną kopię. Spróbuj pobrać ją z flagą \texttt{get --auto}. Zasymuluj
    awarię jednego ze zdalnych repozytoriów a następnie usuń je z indeksu
    git-annex. Sprawdź ile kopii pliku ustnieje w systemie. Czy teraz możesz
    pobrać go do lokalnego repozytorium z użyciem flagi \texttt{--auto}?.

\ifteacher
    \begin{lstlisting}
[root@lab429-08 hostB-main.git]# git annex get --auto plik.bin
get plik.bin (from hostB-backup...) SHA256-s512000000--4c98cf638799a07eb85872e7f5f5d8d661c09e6e15af02f3655ed9250cae13b0
512000000 100\% 56.26MB/s 0:00:08 (xfer#1, to-check=0/1)

sent 512062644 bytes received 31 bytes 53901334.21 bytes/sec
total size is 512000000 speedup is 1.00
ok
(Recording state in git...)
    \end{lstlisting}
\fi

    \item
    Zasymuluj zmianę którejś z kopii pliku \texttt{plik.bin}.
    Upewnij się, że posiadasz co najmniej dwie kopie i zmodyfikuj zawartość
    pliku bezpośrednio w systemie plików.
    Wykorzystaj \texttt{git-annex} do wykrycia niepoprawnej kopii, jej
    usunięcia z systemu i odtworzenia poprawnej kopii.

\ifteacher
    \begin{lstlisting}
hostB-main.git$ git annex fsck --from hostB-backup plik.bin
fsck plik.bin Bad file size (7 B larger); dropped from hostB-backup

Only 1 of 2 trustworthy copies exist of plik.bin
Back it up with git-annex copy.
failed
(Recording state in git...)
git-annex: fsck: 1 failed

hostB-main.git$ git annex get --auto plik.bin
get plik.bin (from hostA-main...) SHA256-s512000000--4c98cf638799a07eb85872e7f5f5d8d661c09e6e15af02f3655ed9250cae13b0
512000000 100\% 45.54MB/s 0:00:10 (xfer#1, to-check=0/1)

sent 30 bytes received 512062649 bytes 44527189.48 bytes/sec
total size is 512000000 speedup is 1.00
ok
(Recording state in git...)
    \end{lstlisting}
\fi

    \item
    \textbf{Zadanie dodatkowe.} Załóż konto w serwisie
    \href{https://gitlab.com}{https://gitlab.com}
    \footnote{Gitlab.com oferuje 10GB darmowego miejsca na przechowywanie
    plików z użyciem systemu git-annex}.
    Gitlab wspiera tylko autentykację przy użyciu klucza publicznego. Dodaj
    w panelu ustawień konta klucz wygenerowany na początku ćwiczenia.
    Utwórz repozytorium i dodaj je jako remote do istniejącego repozytorium.
    Zsynchronizuj status git-annex. Zbadaj szybkość transferu 50MB pliku do
    Gitlab.com, do drugiej maszyny w sieci lokalnej i do repozytorium na tej
    samej maszynie.

    \begin{tabular}{|l|p{.7\textwidth}|}
    \hline
    & prędkość transferu [MB/s] \\
    \hline
    przez SSH & \\
    \hline
    kopia lokalna & \\
    \hline
    Gitlab.com & \\
    \hline
    \end{tabular}

\end{enumerate}

\end{document}
